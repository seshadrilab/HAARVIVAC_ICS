---
title: "COMPASS Subset Magnitude Plots"
author: "Jolie Phan"
output: 
  html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: 4
date: "version `r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
---

Pull out the COMPASS subsets with statistically significant magnitude boxplots. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=F}
library(here)
library(tidyverse)
library(COMPASS)
library(ggplot2)
library(data.table)
library(broom)
library(psych)
library(corrplot)
library(ggpubr)
library(knitr)
library(kableExtra)
library(cowplot)
library(purrr)
library(flowWorkspace)
library(GGally)
library(patchwork)
library(RColorBrewer)
library(ComplexHeatmap)
library(ggbeeswarm)
source(here::here("scripts/Helper_Functions.R"))
```

# Font and colors

```{r}
save_output <- FALSE
# Arial font setup. Downloaded afms from https://github.com/microsoft/microsoft-r-open/tree/ec3fd89e5fb5794bd8149905c134ad801bb61800
Arial <- Type1Font(family = "Arial",
                   metrics = c(here::here("data/Arial_afm/ArialMT.afm"),
                               here::here("data/Arial_afm/ArialMT-Bold.afm"),
                               here::here("data/Arial_afm/ArialMT-Italic.afm"),
                               here::here("data/Arial_afm/ArialMT-BoldItalic.afm")))
windowsFonts("Arial" = windowsFont("Arial"))
pdfFonts(Arial = Arial)

display.brewer.pal(n = 12, name = 'Paired')
dev.off()
brewer.pal(n = 12, name = 'Paired')
brewer.pal(n = 12, name = 'Paired')[c(1:2, 5:6)]
# Naive PRE is light blue, Naive POST is dark blue. "#A6CEE3" "#1F78B4"
# Conv PRE is light red, Conv POST is dark red "#FB9A99" "#E31A1C"
```

# Read in data

```{r}
cd4_naive_bg_corr_boxplots <- readRDS(here::here("processed_data/CD4_N_make_boxplot_for_COMPASS_run_list.rds"))

cd4_conv_bg_corr_boxplots <- readRDS(here::here("processed_data/CD4_C_make_boxplot_for_COMPASS_run_list.rds"))

cd4_pre_bg_corr_boxplots <- readRDS(here::here("processed_data/CD4_pre_make_boxplot_for_COMPASS_run_list.rds"))
```

# CD4 Subsets
Data can be extracted from the saved output of `make_boxplot_for_COMPASS_run()`. Note that the p-values have been bonferroni adjusted.

```{r}
plot_subset_vs_group <- function(bg_corr_boxplots, current_run,
                                 current_subset, group_colors,
                                 group_labs, group) {
  current_data <- bg_corr_boxplots[[current_run]]$BgCorrMagnitudes %>% dplyr::select(Individual, Group, !!as.symbol(current_subset)) %>% 
    mutate(BgCorr_Zeroed = ifelse(!!as.symbol(current_subset) < 0, 0, !!as.symbol(current_subset)),
           Group = factor(Group, levels = groups))
  current_test_result <- bg_corr_boxplots[[current_run]]$Test_Results %>% dplyr::filter(BooleanSubset == current_subset)
  current_coreceptor <- sub("([A-Z][A-Z][0-9])_.*", "\\1", current_run)
current_stim <- sub("[A-Z][A-Z][0-9]_(.*)", "\\1", current_run)
  
  cytokine_display_text <- c("IFNg" = "IFNg", "CD154" = "CD154", "TNFa" = "TNFa", 
                "IL2" = "IL2", "IL4_5_13" = "IL-4/5/13", "IL17a" = "IL17a", "CD107a" = "CD107a")
  current_cytokines_vec <- as.data.frame(t(current_test_result[,c("IFNg", "IL2", "TNFa", "CD154", "CD107a", "IL4_5_13", "IL17a")])) %>%
    rownames_to_column("Cyt") %>%
    dplyr::filter(V1 == 1) %>%
    dplyr::pull(Cyt) 
  current_subset_trunc <- paste(paste0(cytokine_display_text[names(cytokine_display_text) %in% current_cytokines_vec], "+"),
                                collapse = " ")
  
  current_plot <- ggplot(current_data, aes(Group, BgCorr_Zeroed)) +
    theme_bw(base_size = 22) +
      geom_hline(yintercept = 0, linetype="dashed", alpha = 0.5) +
      geom_violin(aes(fill = Group), draw_quantiles = c(0.5),
              # All violins have the same maximum width. Overrides default of equal area
              scale="width", width=0.6) +
      geom_violin(fill="transparent", draw_quantiles = c(0.25, 0.75), linetype = "dashed",
                  scale="width", width=0.6) +
      geom_violin(aes(color=Group), fill="transparent",
                scale="width", width=0.6, size=1.1) +
      geom_quasirandom(size=0.1, width=0.2, varwidth=T, method="quasirandom") +
      theme(axis.title.x = element_blank(),
              axis.title.y = element_text(size=15),
              axis.text.y = element_text(color="black", size=17),
              axis.text.x = element_text(color="black", size=20),
              plot.title = element_text(hjust = 0.5, size=21),
              plot.subtitle = element_text(hjust = 0.5, size=13),
              panel.grid = element_blank(),
              legend.position = "none",
              plot.margin = margin(0.3, 0.2, 0.1, 0.2, "cm")) +
      scale_y_continuous(labels = function(x) paste0(x*100)) + 
      scale_x_discrete(labels=group_labs, expand = c(0.3, 0.3)) +
      labs(y = sprintf("%% Responding %s T cells", current_coreceptor),
           title = current_stim,
           subtitle = current_subset_trunc) +
      scale_fill_manual(values = group_colors) +
    scale_color_manual(values = group_colors)
  
  plot_ylims <- ggplot_build(current_plot)$layout$panel_params[[1]]$y.range
  current_plot <- current_plot + 
    annotate("text", x = 1.5, y = plot_ylims[2] + 0.01*diff(plot_ylims),
             label = current_test_result[,"p.adj.text"], size=5.5) +
     coord_cartesian(ylim = c(plot_ylims[[1]], plot_ylims[[2]] + 0.09*diff(plot_ylims)))
  current_plot
}
```

## Spike 1

### Naive PRE vs POST
IFNg+TNFa+IL2+CD154+

```{r, fig.width=5, fig.height=5}
group_colors <- c("Naive PRE" = "#A6CEE3", "Naive POST" = "#1F78B4")
group_labs <- c("Naive PRE" = "Naive PRE", "Naive POST", "Naive POST")
groups <- c("Naive PRE", "Naive POST")
cd4_s1_n_4 <- plot_subset_vs_group(cd4_naive_bg_corr_boxplots, "CD4_S1",
                     "IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&!CD107a",
                     group_colors, group_labs, groups)

cd4_s1_n_4
```

### Conv PRE vs POST
IFNg+TNFa+CD154+
IFNg+CD107a+TNFa+IL2+CD154+

```{r, fig.width=5, fig.height=5}
group_colors <- c("Conv PRE" = "#FB9A99", "Conv POST" = "#E31A1C")
group_labs <- c("Conv PRE" = "Conv PRE", "Conv POST" = "Conv POST")
groups <- c("Conv PRE", "Conv POST")

cd4_s1_c_3 <- plot_subset_vs_group(cd4_conv_bg_corr_boxplots, "CD4_S1",
                     "!IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&!CD107a",
                     group_colors, group_labs, groups)

cd4_s1_c_5 <- plot_subset_vs_group(cd4_conv_bg_corr_boxplots, "CD4_S1",
                     "IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&CD107a",
                     group_colors, group_labs, groups)

cd4_s1_c_3
cd4_s1_c_5
```

### Naive PRE vs Conv PRE
IFNg+TNFa+IL2+CD154+

```{r, fig.width=5, fig.height=5}
group_colors <- c("Naive PRE" = "#A6CEE3", "Conv PRE" = "#FB9A99")
group_labs <- c("Naive PRE" = "Naive PRE", "Conv PRE" = "Conv PRE")
groups <- c("Naive PRE", "Conv PRE")

cd4_s1_nc_4 <- plot_subset_vs_group(cd4_pre_bg_corr_boxplots, "CD4_S1",
                     "IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&!CD107a",
                     group_colors, group_labs, groups)
cd4_s1_nc_4
```

## Spike 2

### Conv PRE vs POST
IFNg+TNFa+CD154+
IFNg+CD107a+TNFa+CD154+
IFNg+CD107a+TNFa+IL2+CD154+

```{r, fig.width=5, fig.height=5}
group_colors <- c("Conv PRE" = "#FB9A99", "Conv POST" = "#E31A1C")
group_labs <- c("Conv PRE" = "Conv PRE", "Conv POST" = "Conv POST")
groups <- c("Conv PRE", "Conv POST")

cd4_s2_c_3 <- plot_subset_vs_group(cd4_conv_bg_corr_boxplots, "CD4_S2",
                     "!IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&!CD107a",
                     group_colors, group_labs, groups)

cd4_s2_c_4 <- plot_subset_vs_group(cd4_conv_bg_corr_boxplots, "CD4_S2",
                     "!IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&CD107a",
                     group_colors, group_labs, groups)

cd4_s2_c_5 <- plot_subset_vs_group(cd4_conv_bg_corr_boxplots, "CD4_S2",
                     "IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&CD107a",
                     group_colors, group_labs, groups)

cd4_s2_c_3
cd4_s2_c_4
cd4_s2_c_5
```

### Naive PRE vs Conv PRE
IFNg+TNFa+IL2+CD154+

```{r, fig.width=5, fig.height=5}
group_colors <- c("Naive PRE" = "#A6CEE3", "Conv PRE" = "#FB9A99")
group_labs <- c("Naive PRE" = "Naive PRE", "Conv PRE" = "Conv PRE")
groups <- c("Naive PRE", "Conv PRE")

cd4_s2_nc_4 <- plot_subset_vs_group(cd4_pre_bg_corr_boxplots, "CD4_S2",
                     "IL2&!IL4_5_13&IFNg&TNFa&!IL17a&CD154&!CD107a",
                     group_colors, group_labs, groups)
cd4_s2_nc_4
```
