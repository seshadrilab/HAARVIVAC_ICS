---
title: "HAARVIVAC ICS Dimensionality Reduction on polyfunctional cells"
author: "Jolie Phan"
date: "version `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: console
---

Run UMAP on polyfunctional CD4+ events (note: this includes the samples that were dropped by COMPASS).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r, message=F}
library(openCyto)
library(CytoML) # 1.12.0
library(flowCore) # required for description()
library(flowWorkspace) # required for gh_pop_get_data()
library(here)
library(tidyverse)
library(uwot)
library(ggplot2)
library(scales)
library(patchwork)
library(hues)
library(RColorBrewer)
library(ggrepel)
library(ggpubr)
library(tidyselect)
library(ggrastr)
source(here::here("scripts/Helper_Functions.R")) # for distributeEvents() and sampleGatingHierarchy()
```

# Load data

```{r}
date <- 20220228
save_output <- FALSE
rerun_dimred <- FALSE
gs <- load_gs(here::here("out/GatingSets/HAARVIVAC_GatingSet_with_bool"))

if(!dir.exists(here::here("out/UMAP"))) {
  cat(sprintf("Creating folder %s\n", here::here("out/UMAP")))
  dir.create(here::here("out/UMAP"), recursive = T)
}
```

# Extract mfi data

```{r}
cd4_gates_for_dimred <- c(
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD107a+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD154+", 
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IFNg+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IL2+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IL17a+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IL4_5_13+", 
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/TNFa+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CCR7+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD45RA+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD38+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/HLADR+")

cd4_cytokine_gates <- c(
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD107a+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD154+", 
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IFNg+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IL2+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IL17a+",
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/IL4_5_13+", 
  "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/TNFa+"
)
```

Get counts for polyfunctional CD4+ events.

```{r}
cd4_polyf_parent <- "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD4_PolyF_Subsets"

# CD4_PolyF_Subsets1
pop_counts <- pData(gs) %>%
  tibble::rownames_to_column("rowname") %>%
  left_join(gs_pop_get_count_fast(gs, subpopulations = cd4_polyf_parent), by = c("rowname" = "name")) %>%
  dplyr::rename(CD4_PolyF = Count) %>%
  dplyr::select(rowname, "SAMPLE ID", "EXPERIMENT NAME", Stim, Group, CD4_PolyF) %>%
  dplyr::filter(Stim != "SEB")

sum(pop_counts$CD4_PolyF) # 264705
```

Extract data for dimensionality reduction (not actually sampling).

```{r}
call_sampleGatingHierarchy_for_cd4 <- function(currentSampleName) {
  sampleGatingHierarchy(gs[[currentSampleName]], cd4_polyf_parent, n = NULL, otherGates = cd4_gates_for_dimred)
}

cd4_polyf_subsets_data <- map_dfr(pop_counts$rowname, call_sampleGatingHierarchy_for_cd4) 
dim(cd4_polyf_subsets_data)
knitr::kable(head(cd4_polyf_subsets_data))
```

# Perform dimensionality reduction

```{r}
cols_4_dimred <- c("CD3", "CD8b", "CD4", "TNFa", "CD107a", "CD154", "IL2", "IL17a", "IL4_5_13", "IFNg", "CCR7", "CD45RA", "CD38", "HLADR")

# Scale CD4 polyfunctional subset counts 
cd4.scaled_dimred_input <- cd4_polyf_subsets_data %>%
  dplyr::select("EXPERIMENT NAME", all_of(cols_4_dimred)) %>%
  group_by(`EXPERIMENT NAME`) %>%
  nest() %>%
  ungroup() %>%
  mutate(data = lapply(data, function(df) {as.data.frame(scale(as.matrix(df)))})) %>%
  unnest(cols = c(data)) %>%
  rename_at(vars(all_of(cols_4_dimred)),function(x) paste0(x,".scaled")) %>% 
  dplyr::select(-"EXPERIMENT NAME")

cd4_polyf_subsets_data <- cbind(cd4_polyf_subsets_data, cd4.scaled_dimred_input)

if(rerun_dimred) {
  print("Running UMAP")
  set.seed(date)
  print(Sys.time())
  cd4_polyf_subsets_dimred_out <- cd4_polyf_subsets_data %>%
    # Run CD3, co-receptor, cytokine, memory, and activation markers through UMAP
    dplyr::select(all_of(paste0(cols_4_dimred, ".scaled"))) %>%
    uwot::umap(spread = 1, min_dist = 0.02, n_threads = 7)
  print(Sys.time())
  cd4_polyf_subsets_w_umap <- cbind(as.data.frame(cd4_polyf_subsets_dimred_out) %>%
    dplyr::rename(x.umap = V1, y.umap = V2),
  cd4_polyf_subsets_data)
  if(save_output) {
    saveRDS(cd4_polyf_subsets_w_umap, here::here(sprintf("out/UMAP/%s_ICS_CD4_PolyF_Subsets_UMAP_Unsampled.rds", date)))
    }
} else {
  # Assuming UMAP results are already saved
  print("Loading saved UMAP run")
  cd4_polyf_subsets_w_umap <- readRDS(here::here(sprintf("out/UMAP/%s_ICS_CD4_PolyF_Subsets_UMAP_Unsampled.rds", date)))
}
```

# Plot UMAP results

```{r}
set.seed(date)
cd4_polyf_subsets_w_umap <- cd4_polyf_subsets_w_umap[sample(nrow(cd4_polyf_subsets_w_umap), nrow(cd4_polyf_subsets_w_umap)),]
```

```{r}
# Arial font setup. Downloaded afms from https://github.com/microsoft/microsoft-r-open/tree/ec3fd89e5fb5794bd8149905c134ad801bb61800
Arial <- Type1Font(family = "Arial",
                   metrics = c(here::here("data/Arial_afm/ArialMT.afm"),
                               here::here("data/Arial_afm/ArialMT-Bold.afm"), 
                              here::here("data/Arial_afm/ArialMT-Italic.afm"),                          here::here("data/Arial_afm/ArialMT-BoldItalic.afm")))
windowsFonts("Arial" = windowsFont("Arial"))
pdfFonts(Arial = Arial)

boolColorScheme <- c("FALSE" = "#9E9E9E", "TRUE" = "#C7254A")

cd4_polyf_subsets_w_umap <- cd4_polyf_subsets_w_umap %>%
  mutate(cytokine_degree = rowSums(dplyr::select(., all_of(cd4_cytokine_gates))))

stim_labs <- c("DMSO", "S1", "S2", "NCAP")
names(stim_labs) <- c("DMSO", "S1", "S2", "NCAP")
group_labs <- c("Naive PRE", "Naive POST", "Conv PRE", "Conv POST")
names(group_labs) <- c("Naive PRE", "Naive POST", "Conv PRE", "Conv POST")

base_dimred_plot <- function(currentColumn, pointSize = 0.02, colorScheme = NA) {
  p <- ggplot(cd4_polyf_subsets_w_umap, aes(x=x.umap, y=y.umap,
                                       colour=if(currentColumn %in% c("EXPERIMENT NAME", "SAMPLE ID")) {
                                         factor(!!as.name(currentColumn))
                                         } else {
                                           as.logical(!!as.name(currentColumn))
                                           })) +
    geom_point_rast(shape=20, alpha=0.8, size=pointSize) +
    facet_grid(Group ~ Stim, switch="y",
               labeller = labeller(Group = group_labs, Stim = stim_labs)) +
    theme_bw() +
    theme(plot.title=element_text(hjust = 0.5, size=22, face="bold"),
          axis.text=element_blank(),
          axis.line=element_blank(),
          axis.ticks=element_blank(),
          axis.title=element_blank(),
          strip.text=element_text(face="bold", size=10),
          panel.grid.major = element_blank(),
          legend.title=element_text(face="bold", size=14),
          strip.text.x = element_text(margin = margin(0.15,0,0.15,0, "cm")))
  if(!anyNA(colorScheme)) {
    p <- p + scale_color_manual(values = colorScheme)
  }
  if(currentColumn %in% c("EXPERIMENT NAME", "SAMPLE ID")) {
    p <- p + labs(color = currentColumn) +
      guides(colour = guide_legend(override.aes = list(size=7))) +
      theme(legend.title = element_text(size=10),
            legend.text = element_text(size=10),
            legend.position = "bottom") +
      scale_colour_manual(values=as.character(iwanthue(length(unique(cd4_polyf_subsets_w_umap[,currentColumn])))))
  } else {
    p <- p + theme(legend.position = "none")
  }
  p
}
```

## Look for batch and patient sub-clustering

```{r, fig.width=10, fig.height=8}
base_dimred_plot("EXPERIMENT NAME")
```

```{r, fig.width=10, fig.height=8}
base_dimred_plot("SAMPLE ID")
```

## Individual marker expression localization

```{r, fig.width=10, fig.height=8}
for(cg in cd4_gates_for_dimred) {
  print(base_dimred_plot(cg, colorScheme = boolColorScheme) +
    labs(title = sprintf("CD4+ COMPASS Subset+ UMAP\nColored by %s", sub(".*\\/([^(\\/)]+)", "\\1", cg))))
}
```

## Memory

Colored by gate membership (TEMRA, TEM, TCM, Naive)

First, add memory category column. 

```{r}
getMemoryCategory <- function(CD45RA, CCR7) {
  if(CD45RA & CCR7) {
    "Naive"
  } else if(CD45RA & !CCR7) {
    "TEMRA"
  } else if(!CD45RA & CCR7) {
    "TCM"
  } else if(!CD45RA & !CCR7) {
    "TEM"
  } else {
    "Uncategorized"
  }
}

cd4_polyf_subsets_w_umap$MemoryCategory <- pmap_chr(.l = list(cd4_polyf_subsets_w_umap$`/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD45RA+`,
                                                               cd4_polyf_subsets_w_umap$`/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CCR7+`),
                                                     .f = getMemoryCategory)
memColorScheme <- c("TEM" = "#9E0142", "TEMRA" = "#BEE4A0", "TCM" = "#5E4FA2", "Naive" = "#FDBE6F")
```

Subset data.

```{r}
naive_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Naive PRE" | Group == "Naive POST")

naive_pre_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Naive PRE")

naive_post_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Naive POST")

conv_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Conv PRE" | Group == "Conv POST")

conv_pre_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Conv PRE")

conv_post_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Conv POST")
```

Set ggplot settings (use these for the activation plots too).

```{r}
pointSize <- 0.02

# All data
gg_themes <- ggplot(cd4_polyf_subsets_w_umap, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(cd4_polyf_subsets_w_umap$x.umap)*1.16) +
  scale_y_continuous(limits=range(cd4_polyf_subsets_w_umap$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=10, face="bold"),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.margin = margin(1, 0, 0, 0, unit = "pt"))

# Naive 
naive_gg_themes <- ggplot(naive_data, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(naive_data$x.umap)*1.16) +
  scale_y_continuous(limits=range(naive_data$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=10, face="bold"),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.margin = margin(1, 0, 0, 0, unit = "pt"))

# Naive PRE
naive_pre_gg_themes <- ggplot(naive_pre_data, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(naive_pre_data$x.umap)*1.16) +
  scale_y_continuous(limits=range(naive_pre_data$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=10, face="bold"),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.margin = margin(1, 0, 0, 0, unit = "pt"))

# Naive POST
naive_post_gg_themes <- ggplot(naive_post_data, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(naive_post_data$x.umap)*1.16) +
  scale_y_continuous(limits=range(naive_post_data$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=10, face="bold"),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.margin = margin(1, 0, 0, 0, unit = "pt"))

# Conv
conv_gg_themes <- ggplot(conv_data, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(conv_data$x.umap)*1.16) +
  scale_y_continuous(limits=range(conv_data$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=10, face="bold"),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.margin = margin(1, 0, 0, 0, unit = "pt"))

# Conv PRE
conv_pre_gg_themes <- ggplot(conv_pre_data, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(conv_pre_data$x.umap)*1.16) +
  scale_y_continuous(limits=range(conv_pre_data$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=10, face="bold"),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.margin = margin(1, 0, 0, 0, unit = "pt"))

# Conv POST
conv_post_gg_themes <- ggplot(conv_post_data, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(conv_post_data$x.umap)*1.16) +
  scale_y_continuous(limits=range(conv_post_data$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=10, face="bold"),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.margin = margin(1, 0, 0, 0, unit = "pt"))
```

### Unstratified

```{r}
mem_plot_colored_by_gate <- gg_themes +
  geom_point_rast(aes(colour=cd4_polyf_subsets_w_umap[,"MemoryCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Memory") +
  scale_color_manual(values = memColorScheme)
```

Get legend (use this legend for the rest of the memory plots).

```{r}
mem_legend <- as_ggplot(get_legend(mem_plot_colored_by_gate +
                                     theme(legend.position = "right",
                                           legend.title.align = 0.5) +
                                     guides(colour = guide_legend(override.aes = list(size=9))) +
                                     labs(colour="Memory")))
```

```{r, fig.width=7, fig.height=5}
print(mem_plot_colored_by_gate | mem_legend)
```

### Stratified by infection status

```{r}
naive_mem_plot_colored_by_gate <- naive_gg_themes +
  geom_point_rast(aes(colour=naive_data[,"MemoryCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Naive") +
  scale_color_manual(values = memColorScheme)

conv_mem_plot_colored_by_gate <- conv_gg_themes +
  geom_point_rast(aes(colour=conv_data[,"MemoryCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Convalescent") +
  scale_color_manual(values = memColorScheme)
```

```{r, fig.width=10, fig.height=8}
print(naive_mem_plot_colored_by_gate | conv_mem_plot_colored_by_gate | mem_legend)
```

### Stratified by timepoint

```{r}
naive_pre_mem_plot_colored_by_gate <- naive_pre_gg_themes +
  geom_point_rast(aes(colour=naive_pre_data[,"MemoryCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Naive PRE") +
  scale_color_manual(values = memColorScheme)

naive_post_mem_plot_colored_by_gate <- naive_post_gg_themes +
  geom_point_rast(aes(colour=naive_post_data[,"MemoryCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Naive POST") +
  scale_color_manual(values = memColorScheme)

conv_pre_mem_plot_colored_by_gate <- conv_pre_gg_themes +
  geom_point_rast(aes(colour=conv_pre_data[,"MemoryCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Conv PRE") +
  scale_color_manual(values = memColorScheme)

conv_post_mem_plot_colored_by_gate <- conv_post_gg_themes +
  geom_point_rast(aes(colour=conv_post_data[,"MemoryCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Conv POST") +
  scale_color_manual(values = memColorScheme)
```

```{r, fig.width=9, fig.height=8}
print((naive_pre_mem_plot_colored_by_gate | naive_post_mem_plot_colored_by_gate | plot_spacer()) / (conv_pre_mem_plot_colored_by_gate | conv_post_mem_plot_colored_by_gate | mem_legend))
```

## Activation

Colored by HLADR+CD38+ and HLADR-CD38-

First, add activation category column.

```{r}
getActivationCategory <- function(HLADR, CD38) {
  if(HLADR & CD38) {
    "HLADR+/CD38+"
  } else if(!HLADR & !CD38) {
    "HLADR-/CD38-"
  } else {
    "Uncategorized"
  }
}

cd4_polyf_subsets_w_umap$ActivationCategory <- pmap_chr(.l = list(cd4_polyf_subsets_w_umap$`/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/HLADR+`,
                                                               cd4_polyf_subsets_w_umap$`/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD38+`),
                                                     .f = getActivationCategory)
actColorScheme <- c("HLADR-/CD38-" = "#999999", "HLADR+/CD38+" = "#D55E00")
```

Subset data.

```{r}
naive_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Naive PRE" | Group == "Naive POST")

naive_pre_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Naive PRE")

naive_post_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Naive POST")

conv_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Conv PRE" | Group == "Conv POST")

conv_pre_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Conv PRE")

conv_post_data <- cd4_polyf_subsets_w_umap %>%
  dplyr::filter(Group == "Conv POST")
```

### Unstratified

```{r}
act_plot_colored_by_gate <- gg_themes +
  geom_point_rast(aes(colour=cd4_polyf_subsets_w_umap[,"ActivationCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Activation") +
  scale_color_manual(values = actColorScheme)
```

Get legend (use this legend for the rest of the activation plots).

```{r}
act_legend <- as_ggplot(get_legend(act_plot_colored_by_gate +
                                     theme(legend.position = "right",
                                           legend.title.align = 0.5) +
                                     guides(colour = guide_legend(override.aes = list(size=9))) +
                                     labs(colour="Activation")))
```

```{r}
print(act_plot_colored_by_gate | act_legend)
```

### Stratified by infection status

```{r}
naive_act_plot_colored_by_gate <- naive_gg_themes +
  geom_point_rast(aes(colour=naive_data[,"ActivationCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Naive") +
  scale_color_manual(values = memColorScheme)

conv_act_plot_colored_by_gate <- conv_gg_themes +
  geom_point_rast(aes(colour=conv_data[,"ActivationCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Convalescent") +
  scale_color_manual(values = memColorScheme)
```

```{r, fig.width=10, fig.height=8}
print(naive_act_plot_colored_by_gate | conv_act_plot_colored_by_gate | act_legend)
```

### Stratified by timepoint

```{r}
naive_pre_act_plot_colored_by_gate <- naive_pre_gg_themes +
  geom_point_rast(aes(colour=naive_pre_data[,"ActivationCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Naive PRE") +
  scale_color_manual(values = memColorScheme)

naive_post_act_plot_colored_by_gate <- naive_post_gg_themes +
  geom_point_rast(aes(colour=naive_post_data[,"ActivationCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Naive POST") +
  scale_color_manual(values = memColorScheme)

conv_pre_act_plot_colored_by_gate <- conv_pre_gg_themes +
  geom_point_rast(aes(colour=conv_pre_data[,"ActivationCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Conv PRE") +
  scale_color_manual(values = memColorScheme)

conv_post_act_plot_colored_by_gate <- conv_post_gg_themes +
  geom_point_rast(aes(colour=conv_post_data[,"ActivationCategory"]),
               shape=20, alpha=0.8, size=pointSize) +
  ggtitle("Conv POST") +
  scale_color_manual(values = memColorScheme)
```

```{r, fig.width=9, fig.height=8}
print((naive_pre_act_plot_colored_by_gate | naive_post_act_plot_colored_by_gate | plot_spacer()) / (conv_pre_act_plot_colored_by_gate | conv_post_act_plot_colored_by_gate | act_legend))
```