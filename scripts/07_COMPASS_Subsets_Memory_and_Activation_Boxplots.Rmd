---
title: "COMPASS Subset CD4+ T cell Memory and Activation Boxplots"
author: "Jolie Phan"
date: "version `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: console
---

Plots frequencies of CD4+ T cells which express a COMPASS subset based on activation phenotype (HLADR+CD38+ and CD38+, HLADR agnostic) and memory phenotype (TCM and TEM).

Stratify by stim (S1, S2, NCAP, and DMSO).

Note: all p-values are unadjusted.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 5, fig.height = 5)
```

```{r, message = FALSE}
library(here)
library(flowWorkspace)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(ggbeeswarm)
```

# Load data

```{r}
gs <- load_gs(here::here("out/GatingSets/HAARVIVAC_GatingSet_with_COMPASS_Subsets"))

if(!dir.exists(here::here("out/post_compass_plots/activation_memory_plots"))) {
    cat(sprintf("Creating folder %s\n", here::here("out/post_compass_plots/activation_memory_plots")))
    dir.create(here::here("out/post_compass_plots/activation_memory_plots"), recursive = T)
}
```

```{r}
# Arial font setup. Downloaded afms from https://github.com/microsoft/microsoft-r-open/tree/ec3fd89e5fb5794bd8149905c134ad801bb61800
Arial <- Type1Font(family = "Arial",
                   metrics = c(here::here("data/Arial_afm/ArialMT.afm"),
                               here::here("data/Arial_afm/ArialMT-Bold.afm"),
                               here::here("data/Arial_afm/ArialMT-Italic.afm"),
                               here::here("data/Arial_afm/ArialMT-BoldItalic.afm")))
windowsFonts("Arial" = windowsFont("Arial"))
pdfFonts(Arial = Arial)
```

# Extract frequencies

Exclude SEB.

```{r}
cd4_compass_act_parent <- "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD4_COMPASS_Subsets/HLADR+CD38+"

cd4_compass_cd38_parent <- "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD4_COMPASS_Subsets/CD38+"

cd4_compass_hladr_parent <- "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD4_COMPASS_Subsets/HLADR+"

cd4_compass_cm_parent <- "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD4_COMPASS_Subsets/TCM"

cd4_compass_em_parent <- "/Time/CD3+/CD14-CD19-/Lymphocytes/Singlet/Live/CD4+/CD4_COMPASS_Subsets/TEM"
```

## HLADR+CD38+

```{r}
act_counts <- pData(gs) %>%
  tibble::rownames_to_column("rowname") %>%
  left_join(gs_pop_get_count_fast(gs, subpopulations = cd4_compass_act_parent), by = c("rowname" = "name")) %>%
  dplyr::rename(CD4_PolyF = Count) %>%
  dplyr::select(rowname, "SAMPLE ID", "EXPERIMENT NAME", Stim, Group, CD4_PolyF, ParentCount) %>%
  dplyr::filter(Stim != "SEB") %>%
  mutate(Freq = (CD4_PolyF/ParentCount)*100) 

# Add infection status column
i1 <- grepl("H", act_counts$`SAMPLE ID`) 
i2 <- grepl("C", act_counts$`SAMPLE ID`) 
act_counts$Infection_Status <- NULL
act_counts$Infection_Status[i1] <- "Naive"
act_counts$Infection_Status[i2] <- "Conv"
act_counts$Infection_Status <- factor(act_counts$Infection_Status, levels = c("Naive", "Conv"))

# Add "Timepoint" column
i3 <- grepl("-1", act_counts$`SAMPLE ID`) 
i4 <- grepl("-2", act_counts$`SAMPLE ID`) 
act_counts$Timepoint <- NULL
act_counts$Timepoint[i3] <- "PRE"
act_counts$Timepoint[i4] <- "POST"

# Add column to pData indicating sample group (Naive vs. Conv and PRE vs. POST)
i5 <- grepl("H", act_counts$`SAMPLE ID`) & grepl("PRE", act_counts$Timepoint)
i6 <- grepl("H", act_counts$`SAMPLE ID`) & grepl("POST", act_counts$Timepoint)
i7 <- grepl("C", act_counts$`SAMPLE ID`) & grepl("PRE", act_counts$Timepoint)
i8 <- grepl("C", act_counts$`SAMPLE ID`) & grepl("POST", act_counts$Timepoint)
act_counts$Group <- NULL
act_counts$Group[i5] <- "Naive PRE"
act_counts$Group[i6] <- "Naive POST"
act_counts$Group[i7] <- "Conv PRE"
act_counts$Group[i8] <- "Conv POST"
act_counts$Group <- factor(act_counts$Group, levels = c("Naive PRE", "Naive POST", "Conv PRE", "Conv POST"))
```

## CD38+

```{r}
cd38_counts <- pData(gs) %>%
  tibble::rownames_to_column("rowname") %>%
  left_join(gs_pop_get_count_fast(gs, subpopulations = cd4_compass_cd38_parent), by = c("rowname" = "name")) %>%
  dplyr::rename(CD4_PolyF = Count) %>%
  dplyr::select(rowname, "SAMPLE ID", "EXPERIMENT NAME", Stim, Group, CD4_PolyF, ParentCount) %>%
  dplyr::filter(Stim != "SEB") %>%
  mutate(Freq = (CD4_PolyF/ParentCount)*100) 

# Add infection status column
i1 <- grepl("H", cd38_counts$`SAMPLE ID`) 
i2 <- grepl("C", cd38_counts$`SAMPLE ID`) 
cd38_counts$Infection_Status <- NULL
cd38_counts$Infection_Status[i1] <- "Naive"
cd38_counts$Infection_Status[i2] <- "Conv"
cd38_counts$Infection_Status <- factor(cd38_counts$Infection_Status, levels = c("Naive", "Conv"))

# Add "Timepoint" column
i3 <- grepl("-1", cd38_counts$`SAMPLE ID`) 
i4 <- grepl("-2", cd38_counts$`SAMPLE ID`) 
cd38_counts$Timepoint <- NULL
cd38_counts$Timepoint[i3] <- "PRE"
cd38_counts$Timepoint[i4] <- "POST"

# Add column to pData indicating sample group (Naive vs. Conv and PRE vs. POST)
i5 <- grepl("H", cd38_counts$`SAMPLE ID`) & grepl("PRE", cd38_counts$Timepoint)
i6 <- grepl("H", cd38_counts$`SAMPLE ID`) & grepl("POST", cd38_counts$Timepoint)
i7 <- grepl("C", cd38_counts$`SAMPLE ID`) & grepl("PRE", cd38_counts$Timepoint)
i8 <- grepl("C", cd38_counts$`SAMPLE ID`) & grepl("POST", cd38_counts$Timepoint)
cd38_counts$Group <- NULL
cd38_counts$Group[i5] <- "Naive PRE"
cd38_counts$Group[i6] <- "Naive POST"
cd38_counts$Group[i7] <- "Conv PRE"
cd38_counts$Group[i8] <- "Conv POST"
cd38_counts$Group <- factor(cd38_counts$Group, levels = c("Naive PRE", "Naive POST", "Conv PRE", "Conv POST"))
```

## HLADR+

```{r}
hladr_counts <- pData(gs) %>%
  tibble::rownames_to_column("rowname") %>%
  left_join(gs_pop_get_count_fast(gs, subpopulations = cd4_compass_hladr_parent), by = c("rowname" = "name")) %>%
  dplyr::rename(CD4_PolyF = Count) %>%
  dplyr::select(rowname, "SAMPLE ID", "EXPERIMENT NAME", Stim, Group, CD4_PolyF, ParentCount) %>%
  dplyr::filter(Stim != "SEB") %>%
  mutate(Freq = (CD4_PolyF/ParentCount)*100) 

# Add infection status column
i1 <- grepl("H", hladr_counts$`SAMPLE ID`) 
i2 <- grepl("C", hladr_counts$`SAMPLE ID`) 
hladr_counts$Infection_Status <- NULL
hladr_counts$Infection_Status[i1] <- "Naive"
hladr_counts$Infection_Status[i2] <- "Conv"
hladr_counts$Infection_Status <- factor(hladr_counts$Infection_Status, levels = c("Naive", "Conv"))

# Add "Timepoint" column
i3 <- grepl("-1", hladr_counts$`SAMPLE ID`) 
i4 <- grepl("-2", hladr_counts$`SAMPLE ID`) 
hladr_counts$Timepoint <- NULL
hladr_counts$Timepoint[i3] <- "PRE"
hladr_counts$Timepoint[i4] <- "POST"

# Add column to pData indicating sample group (Naive vs. Conv and PRE vs. POST)
i5 <- grepl("H", hladr_counts$`SAMPLE ID`) & grepl("PRE", hladr_counts$Timepoint)
i6 <- grepl("H", hladr_counts$`SAMPLE ID`) & grepl("POST", hladr_counts$Timepoint)
i7 <- grepl("C", hladr_counts$`SAMPLE ID`) & grepl("PRE", hladr_counts$Timepoint)
i8 <- grepl("C", hladr_counts$`SAMPLE ID`) & grepl("POST", hladr_counts$Timepoint)
hladr_counts$Group <- NULL
hladr_counts$Group[i5] <- "Naive PRE"
hladr_counts$Group[i6] <- "Naive POST"
hladr_counts$Group[i7] <- "Conv PRE"
hladr_counts$Group[i8] <- "Conv POST"
hladr_counts$Group <- factor(hladr_counts$Group, levels = c("Naive PRE", "Naive POST", "Conv PRE", "Conv POST"))
```

## Central memory

```{r}
cm_counts <- pData(gs) %>%
  tibble::rownames_to_column("rowname") %>%
  left_join(gs_pop_get_count_fast(gs, subpopulations = cd4_compass_cm_parent), by = c("rowname" = "name")) %>%
  dplyr::rename(CD4_PolyF = Count) %>%
  dplyr::select(rowname, "SAMPLE ID", "EXPERIMENT NAME", Stim, Group, CD4_PolyF, ParentCount) %>%
  dplyr::filter(Stim != "SEB") %>%
  mutate(Freq = (CD4_PolyF/ParentCount)*100) 

# Add infection status column
i1 <- grepl("H", cm_counts$`SAMPLE ID`) 
i2 <- grepl("C", cm_counts$`SAMPLE ID`) 
cm_counts$Infection_Status <- NULL
cm_counts$Infection_Status[i1] <- "Naive"
cm_counts$Infection_Status[i2] <- "Conv"
cm_counts$Infection_Status <- factor(cm_counts$Infection_Status, levels = c("Naive", "Conv"))

# Add "Timepoint" column
i3 <- grepl("-1", cm_counts$`SAMPLE ID`) 
i4 <- grepl("-2", cm_counts$`SAMPLE ID`) 
cm_counts$Timepoint <- NULL
cm_counts$Timepoint[i3] <- "PRE"
cm_counts$Timepoint[i4] <- "POST"

# Add column to pData indicating sample group (Naive vs. Conv and PRE vs. POST)
i5 <- grepl("H", cm_counts$`SAMPLE ID`) & grepl("PRE", cm_counts$Timepoint)
i6 <- grepl("H", cm_counts$`SAMPLE ID`) & grepl("POST", cm_counts$Timepoint)
i7 <- grepl("C", cm_counts$`SAMPLE ID`) & grepl("PRE", cm_counts$Timepoint)
i8 <- grepl("C", cm_counts$`SAMPLE ID`) & grepl("POST", cm_counts$Timepoint)
cm_counts$Group <- NULL
cm_counts$Group[i5] <- "Naive PRE"
cm_counts$Group[i6] <- "Naive POST"
cm_counts$Group[i7] <- "Conv PRE"
cm_counts$Group[i8] <- "Conv POST"
cm_counts$Group <- factor(cm_counts$Group, levels = c("Naive PRE", "Naive POST", "Conv PRE", "Conv POST"))
```

## Effector memory

```{r}
em_counts <- pData(gs) %>%
  tibble::rownames_to_column("rowname") %>%
  left_join(gs_pop_get_count_fast(gs, subpopulations = cd4_compass_em_parent), by = c("rowname" = "name")) %>%
  dplyr::rename(CD4_PolyF = Count) %>%
  dplyr::select(rowname, "SAMPLE ID", "EXPERIMENT NAME", Stim, Group, CD4_PolyF, ParentCount) %>%
  dplyr::filter(Stim != "SEB") %>%
  mutate(Freq = (CD4_PolyF/ParentCount)*100) 

# Add infection status column
i1 <- grepl("H", em_counts$`SAMPLE ID`) 
i2 <- grepl("C", em_counts$`SAMPLE ID`) 
em_counts$Infection_Status <- NULL
em_counts$Infection_Status[i1] <- "Naive"
em_counts$Infection_Status[i2] <- "Conv"
em_counts$Infection_Status <- factor(em_counts$Infection_Status, levels = c("Naive", "Conv"))

# Add "Timepoint" column
i3 <- grepl("-1", em_counts$`SAMPLE ID`) 
i4 <- grepl("-2", em_counts$`SAMPLE ID`) 
em_counts$Timepoint <- NULL
em_counts$Timepoint[i3] <- "PRE"
em_counts$Timepoint[i4] <- "POST"

# Add column to pData indicating sample group (Naive vs. Conv and PRE vs. POST)
i5 <- grepl("H", em_counts$`SAMPLE ID`) & grepl("PRE", em_counts$Timepoint)
i6 <- grepl("H", em_counts$`SAMPLE ID`) & grepl("POST", em_counts$Timepoint)
i7 <- grepl("C", em_counts$`SAMPLE ID`) & grepl("PRE", em_counts$Timepoint)
i8 <- grepl("C", em_counts$`SAMPLE ID`) & grepl("POST", em_counts$Timepoint)
em_counts$Group <- NULL
em_counts$Group[i5] <- "Naive PRE"
em_counts$Group[i6] <- "Naive POST"
em_counts$Group[i7] <- "Conv PRE"
em_counts$Group[i8] <- "Conv POST"
em_counts$Group <- factor(em_counts$Group, levels = c("Naive PRE", "Naive POST", "Conv PRE", "Conv POST"))
```

# Boxplots

```{r}
stims <- c("DMSO", "S1", "S2", "NCAP")

fill_colors <- list("Naive" = c("Naive PRE" = "#A6CEE3", "Naive POST" = "#1F78B4"),
                    "Conv" = c("Conv PRE" = "#FB9A99", "Conv POST" = "#E31A1C"),
                    "PRE" = c("Naive PRE" = "#A6CEE3", "Conv PRE" = "#FB9A99"),
                    "POST" = c("Naive POST" = "#1F78B4", "Conv POST" = "#E31A1C"))

outline_colors <- list("Naive" = c("Naive PRE" = "#7FB9D7", "Naive POST" = "#185b88"),
                       "Conv" = c("Conv PRE" = "#F96968", "Conv POST" = "#B51516"),
                       "PRE" = c("Naive PRE" = "#7FB9D7", "Conv PRE" = "#F96968"),
                       "POST" = c("Naive POST" = "#185b88", "Conv POST" = "#B51516"))
```

```{r}
make_boxplots <- function(counts, compare_time, keep, current_stim,
                          groups_compare, paired, fill_colors,
                          outline_colors, subtitle) {
  if(compare_time) {
    counts <- counts %>%
      dplyr::filter(Infection_Status == keep & Stim == current_stim)
  } else
    counts <- counts %>%
      dplyr::filter(Timepoint == keep & Stim == current_stim)
  
  # P-values are unadjusted
  if(paired) {
    test <- wilcox.test(Freq ~ Group, data = counts, paired = TRUE)
  } else {
    test <- wilcox.test(Freq ~ Group, data = counts, paired = FALSE)
  }

test_df <- data.frame(p = as.numeric(unlist(test)["p.value"])) %>%
  mutate(p.text = if_else(p < 0.001, "p<.001", paste0("p=", sub("0.", ".", round(p, 3)))))
  
  current_plot <- ggplot(counts, aes(x = Group, y = Freq)) +
    theme_bw(base_size = 22) +
    geom_hline(yintercept = 0, linetype="dashed", alpha = 0.5) +
    geom_violin(aes(fill = Group), draw_quantiles = c(0.5),
              # All violins have the same maximum width. Overrides default of equal area
              scale="width", width=0.6) +
    geom_violin(fill="transparent", draw_quantiles = c(0.25, 0.75), linetype = "dashed",
                  scale="width", width=0.6) +
    geom_violin(aes(color=Group), fill="transparent",
                scale="width", width=0.6, size=1.1) +
    geom_quasirandom(size=0.1, width=0.2, varwidth=T, method="quasirandom") +
    theme(text = element_text(family="Arial"),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size=15),
          axis.text.y = element_text(color="black", size=17),
          axis.text.x = element_text(color="black", size=20),
          plot.title = element_text(hjust = 0.5, size=21),
          plot.subtitle = element_text(hjust = 0.5, size=13),
          panel.grid = element_blank(),
          legend.position = "none",
          plot.margin = margin(0.3, 0.2, 0.1, 0.2, "cm")) +
    labs(title = as.character(current_stim),
         subtitle = subtitle,
         y = "% COMPASS-selected CD4+ T Cells") +
    scale_x_discrete(labels = groups_compare, expand = c(0.3, 0.3)) +
    scale_fill_manual(values = fill_colors[[keep]]) +
    scale_color_manual(values = outline_colors[[keep]]) 
  
  plot_ylims <- ggplot_build(current_plot)$layout$panel_params[[1]]$y.range
  
  current_plot <- current_plot + 
    annotate("text", x = 1.5, y = plot_ylims[2] + 0.01*diff(plot_ylims),
             label = test_df$p.text, size=5.5) +
     coord_cartesian(ylim = c(plot_ylims[[1]], plot_ylims[[2]] + 0.09*diff(plot_ylims)))
}
```

## HLADR+CD38+

### Naive PRE vs Naive POST

```{r}
naive_act_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(act_counts, current_stim = n, compare_time = TRUE, keep = "Naive", groups_compare = c("Naive PRE", "Naive POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+CD38+")
                               })
names(naive_act_plots) <- stims
```

```{r}
naive_act_plots[["DMSO"]]
```

```{r}
naive_act_plots[["NCAP"]]
```

```{r}
naive_act_plots[["S1"]]
```

```{r}
naive_act_plots[["S2"]]
```

### Conv PRE vs Conv POST

```{r}
conv_act_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(act_counts, current_stim = n, compare_time = TRUE, keep = "Conv", groups_compare = c("Conv PRE", "Conv POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+CD38+")
                               })
names(conv_act_plots) <- stims
```

```{r}
conv_act_plots[["DMSO"]]
```

```{r}
conv_act_plots[["NCAP"]]
```

```{r}
conv_act_plots[["S1"]]
```

```{r}
conv_act_plots[["S2"]]
```

### Naive PRE vs Conv PRE

```{r}
pre_act_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(act_counts, current_stim = n, compare_time = FALSE, keep = "PRE", groups_compare = c("Naive PRE", "Conv PRE"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+CD38+")
                               })
names(pre_act_plots) <- stims
```

```{r}
pre_act_plots[["DMSO"]]
```

```{r}
pre_act_plots[["NCAP"]]
```

```{r}
pre_act_plots[["S1"]]
```

```{r}
pre_act_plots[["S2"]]
```

### Naive POST vs Conv POST

```{r}
post_act_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(act_counts, current_stim = n, compare_time = FALSE, keep = "POST", groups_compare = c("Naive POST", "Conv POST"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+CD38+")
                               })
names(post_act_plots) <- stims
```

```{r}
post_act_plots[["DMSO"]]
```

```{r}
post_act_plots[["NCAP"]]
```

```{r}
post_act_plots[["S1"]]
```

```{r}
post_act_plots[["S2"]]
```

## CD38+

### Naive PRE vs Naive POST

```{r}
naive_cd38_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cd38_counts, current_stim = n, compare_time = TRUE, keep = "Naive", groups_compare = c("Naive PRE", "Naive POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "CD38+")
                               })
names(naive_cd38_plots) <- stims
```

```{r}
naive_cd38_plots[["DMSO"]]
```

```{r}
naive_cd38_plots[["NCAP"]]
```

```{r}
naive_cd38_plots[["S1"]]
```

```{r}
naive_cd38_plots[["S2"]]
```

### Conv PRE vs Conv POST

```{r}
conv_cd38_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cd38_counts, current_stim = n, compare_time = TRUE, keep = "Conv", groups_compare = c("Conv PRE", "Conv POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "CD38+")
                               })
names(conv_cd38_plots) <- stims
```

```{r}
conv_cd38_plots[["DMSO"]]
```

```{r}
conv_cd38_plots[["NCAP"]]
```

```{r}
conv_cd38_plots[["S1"]]
```

```{r}
conv_cd38_plots[["S2"]]
```

### Naive PRE vs Conv PRE

```{r}
pre_cd38_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cd38_counts, current_stim = n, compare_time = FALSE, keep = "PRE", groups_compare = c("Naive PRE", "Conv PRE"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "CD38+")
                               })
names(pre_cd38_plots) <- stims
```

```{r}
pre_cd38_plots[["DMSO"]]
```

```{r}
pre_cd38_plots[["NCAP"]]
```

```{r}
pre_cd38_plots[["S1"]]
```

```{r}
pre_cd38_plots[["S2"]]
```

### Naive POST vs Conv POST

```{r}
post_cd38_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cd38_counts, current_stim = n, compare_time = FALSE, keep = "POST", groups_compare = c("Naive POST", "Conv POST"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "CD38+")
                               })
names(post_cd38_plots) <- stims
```

```{r}
post_cd38_plots[["DMSO"]]
```

```{r}
post_cd38_plots[["NCAP"]]
```

```{r}
post_cd38_plots[["S1"]]
```

```{r}
post_cd38_plots[["S2"]]
```

## HLADR+

### Naive PRE vs Naive POST

```{r}
naive_hladr_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(hladr_counts, current_stim = n, compare_time = TRUE, keep = "Naive", groups_compare = c("Naive PRE", "Naive POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+")
                               })
names(naive_hladr_plots) <- stims
```

```{r}
naive_hladr_plots[["DMSO"]]
```

```{r}
naive_hladr_plots[["NCAP"]]
```

```{r}
naive_hladr_plots[["S1"]]
```

```{r}
naive_hladr_plots[["S2"]]
```

### Conv PRE vs Conv POST

```{r}
conv_hladr_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(hladr_counts, current_stim = n, compare_time = TRUE, keep = "Conv", groups_compare = c("Conv PRE", "Conv POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+")
                               })
names(conv_hladr_plots) <- stims
```

```{r}
conv_hladr_plots[["DMSO"]]
```

```{r}
conv_hladr_plots[["NCAP"]]
```

```{r}
conv_hladr_plots[["S1"]]
```

```{r}
conv_hladr_plots[["S2"]]
```

### Naive PRE vs Conv PRE

```{r}
pre_hladr_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(hladr_counts, current_stim = n, compare_time = FALSE, keep = "PRE", groups_compare = c("Naive PRE", "Conv PRE"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+")
                               })
names(pre_hladr_plots) <- stims
```

```{r}
pre_hladr_plots[["DMSO"]]
```

```{r}
pre_hladr_plots[["NCAP"]]
```

```{r}
pre_hladr_plots[["S1"]]
```

```{r}
pre_hladr_plots[["S2"]]
```

### Naive POST vs Conv POST

```{r}
post_hladr_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(hladr_counts, current_stim = n, compare_time = FALSE, keep = "POST", groups_compare = c("Naive POST", "Conv POST"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "HLADR+")
                               })
names(post_hladr_plots) <- stims
```

```{r}
post_hladr_plots[["DMSO"]]
```

```{r}
post_hladr_plots[["NCAP"]]
```

```{r}
post_hladr_plots[["S1"]]
```

```{r}
post_hladr_plots[["S2"]]
```

## Central Memory

### Naive PRE vs Naive POST

```{r}
naive_cm_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cm_counts, current_stim = n, compare_time = TRUE, keep = "Naive", groups_compare = c("Naive PRE", "Naive POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Central Memory (CD45RA-CCR7+)")
                               })
names(naive_cm_plots) <- stims
```

```{r}
naive_cm_plots[["DMSO"]]
```

```{r}
naive_cm_plots[["NCAP"]]
```

```{r}
naive_cm_plots[["S1"]]
```

```{r}
naive_cm_plots[["S2"]]
```

### Conv PRE vs Conv POST

```{r}
conv_cm_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cm_counts, current_stim = n, compare_time = TRUE, keep = "Conv", groups_compare = c("Conv PRE", "Conv POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Central Memory (CD45RA-CCR7+)")
                               })
names(conv_cm_plots) <- stims
```

```{r}
conv_cm_plots[["DMSO"]]
```

```{r}
conv_cm_plots[["NCAP"]]
```

```{r}
conv_cm_plots[["S1"]]
```

```{r}
conv_cm_plots[["S2"]]
```

### Naive PRE vs Conv PRE

```{r}
pre_cm_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cm_counts, current_stim = n, compare_time = FALSE, keep = "PRE", groups_compare = c("Naive PRE", "Conv PRE"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Central Memory (CD45RA-CCR7+)")
                               })
names(pre_cm_plots) <- stims
```

```{r}
pre_cm_plots[["DMSO"]]
```

```{r}
pre_cm_plots[["NCAP"]]
```

```{r}
pre_cm_plots[["S1"]]
```

```{r}
pre_cm_plots[["S2"]]
```

### Naive POST vs Conv POST

```{r}
post_cm_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(cm_counts, current_stim = n, compare_time = FALSE, keep = "POST", groups_compare = c("Naive POST", "Conv POST"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Central Memory (CD45RA-CCR7+)")
                               })
names(post_cm_plots) <- stims
```

```{r}
post_cm_plots[["DMSO"]]
```

```{r}
post_cm_plots[["NCAP"]]
```

```{r}
post_cm_plots[["S1"]]
```

```{r}
post_cm_plots[["S2"]]
```

## Effector Memory

### Naive PRE vs Naive POST

```{r}
naive_em_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(em_counts, current_stim = n, compare_time = TRUE, keep = "Naive", groups_compare = c("Naive PRE", "Naive POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Effector Memory (CD45RA-CCR7-)")
                               })
names(naive_em_plots) <- stims
```

```{r}
naive_em_plots[["DMSO"]]
```

```{r}
naive_em_plots[["NCAP"]]
```

```{r}
naive_em_plots[["S1"]]
```

```{r}
naive_em_plots[["S2"]]
```

### Conv PRE vs Conv POST

```{r}
conv_em_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(em_counts, current_stim = n, compare_time = TRUE, keep = "Conv", groups_compare = c("Conv PRE", "Conv POST"), paired = TRUE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Effector Memory (CD45RA-CCR7-)")
                               })
names(conv_em_plots) <- stims
```

```{r}
conv_em_plots[["DMSO"]]
```

```{r}
conv_em_plots[["NCAP"]]
```

```{r}
conv_em_plots[["S1"]]
```

```{r}
conv_em_plots[["S2"]]
```

### Naive PRE vs Conv PRE

```{r}
pre_em_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(em_counts, current_stim = n, compare_time = FALSE, keep = "PRE", groups_compare = c("Naive PRE", "Conv PRE"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Effector Memory (CD45RA-CCR7-)")
                               })
names(pre_em_plots) <- stims
```

```{r}
pre_em_plots[["DMSO"]]
```

```{r}
pre_em_plots[["NCAP"]]
```

```{r}
pre_em_plots[["S1"]]
```

```{r}
pre_em_plots[["S2"]]
```

### Naive POST vs Conv POST

```{r}
post_em_plots <- purrr::pmap(.l = list(stims),
                               .f = function(n) {
                                 make_boxplots(em_counts, current_stim = n, compare_time = FALSE, keep = "POST", groups_compare = c("Naive POST", "Conv POST"), paired = FALSE, fill_colors = fill_colors, outline_colors = outline_colors, subtitle = "Effector Memory (CD45RA-CCR7-)")
                               })
names(post_em_plots) <- stims
```

```{r}
post_em_plots[["DMSO"]]
```

```{r}
post_em_plots[["NCAP"]]
```

```{r}
post_em_plots[["S1"]]
```

```{r}
post_em_plots[["S2"]]
```
